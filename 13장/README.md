# 13장 : 동시성
## 📌 들어가며

> 객체는 처리의 추상화다. 스레드는 일정의 추상화다.
- 동시성과 깔끔한 코드는 양립하기 아-주 어려움.
- 단일 스레드와 다중 스레드 코드 모두 짜기는 쉽고 잘 돌아가지만… 그건… 시스템이 부하 받기 전까지임.
- 이 장에서 배울 내용 : 여러 스레드 동시 돌리는 것의 어려움과 대처 및 깨끗한 코드 작성하기

## 📌 동시성이 필요한 이유

- 동시성 : 결합을 없애는 전략
    - 무엇(what)과 언제(when)을 분리하는 전략
    - 스레드가 하나인 프로그램 → 무엇과 언제가 서로 밀접
- 무엇과 언제를 분리하면 애플리케이션 구조와 효율이 극적으로 나아짐.
- 예시 : 서블릿 모델의 동시성
    - 서블릿은 웹 혹은 EJB 컨테이너라는 우산 아래서 돌아감.
    - 컨테이너는 동시성을 부분적으로 관리
    - 웹 요청이 들어올 때마다 웹 서버는 비동기식으로 서블릿을 실행
    - 각 서블릿 스레드는 다른 서블릿 스레드와 무관하게 자신만의 세상에서 돌아감.
    - BUT 웹 컨테이너가 제공하는 결합분리 전략은 완벽과 거리가 멈.
    - 서블릿 프로그래머는 동시성을 정확히 구현하도록 주의를 기울여야 함.
- 구조적 개선만을 위해 동시성을 채택하는 것은 아님.
- 어떤 시스템은 응답 시간과 작업 처리량 개선이라는 요구사항으로 인해 동시성 구현을 꼭 해야함.

### 미신과 오해

다음은 동시성과 관련한 일반적인 미신과 오해다.

- **동시성은 항상 성능을 높여준다?**
    
    때로는 높여줌. 여러 스레드가 프로세서를 공유할 수 있거나, 여러 프로세서가 동시에 처리할 계산이 많은 경우. BUT 일상적으로 발생하는 상황은 아님.
    
- **동시성을 구현해도 설계는 변하지 않는다?**
    
    단일 스레드 시스템과 다중 스레드 시스템은 설계가 판이하게 다름. 일반적으로 **무엇**과 **언제**를 분리하면 시스템 구조가 크게 달라짐.
    
- **웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다?**
    
    실제로는 어떻게 컨테이너가 동작하는지, 어떻게 동시 수정, 데드락 등과 같은 문제를 피할 수 있는지 알아야 함.
    

다음은 동시성과 관련된 타당한 생각 몇 가지다.

- **동시성은 다소 부하를 유발한다.**
- **동시성은 복잡하다.** 간단한 문제라도 동시성은 복잡하다.
- **일반적으로 동시성 버그는 재현하기 어렵다.**
- **동시성을 구현하려면 흔히 근본적인 설계 전략을 재고해야 한다.**

## 📌 난관

동시성을 구현하기 어려운 이유는 무엇일까? 

- 다음 클래스를 보자.
    
    ```jsx
    public class X {
    	private int lastIdUsed;
    
    	public int getNextId() {
    		return ++lastIdUsed;
    	}
    }
    ```
    
    - 인스턴스 X 생성 후 lastIdUsed 필드를 42로 설정한 다음, 두 스레드가 해당 인스턴스 공유
    - 이제 getNextId()를 호출한다면 결과는 셋 중 하나다.
        - 한 스레드는 43을 받는다. 다른 스레드는 44를 받는다. lastIdUsed == 44
        - 한 스레드는 44를 받는다. 다른 스레드는 43을 받는다. lastIdUsed == 44
        - 한 스레드는 43을 받는다. 다른 스레드는 43을 받는다. lastIdUsed == 43
    - 두 스레드가 같은 변수 동시 참조 → 문제가 생길 수 있음.
- 두 스레드가 자바 코드 한 줄을 거쳐가는 경로가 수없이 많은데, 일부 경로가 잘못된 결과를 내놓음.
- 대다수 경로는 올바른 결과를 내놓지만 문제는 잘못된 결과를 내놓는 일부 경로
